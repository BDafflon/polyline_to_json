<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Polyline → GeoJSON + Leaflet</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body { font-family: Arial; max-width: 900px; margin: 40px auto; }
.line-row { display:flex; gap:10px; margin-bottom:10px; align-items:center; }
input { padding:6px; font-size:14px; }
.name { width:120px; }
.polyline { flex:1; }
button { padding:6px 10px; cursor:pointer; display:flex; align-items:center; justify-content:center; border-radius:4px; border:1px solid #ccc; background:transparent; color:#333; font-size:14px; transition: background 0.2s,color 0.2s; }
button:hover { background:#f0f0f0; color:#000; }
.material-icons { font-size:20px; margin-right:4px; }
.actions,.top-actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:20px; }
.top-actions { margin-bottom:20px; }
.trash { border:none; padding:4px; background:transparent; color:#e53935; }
.trash:hover { background:#fce4e4; }
#map { height:500px; margin-top:30px; border:1px solid #ccc; }
</style>
</head>
<body>

<h2>Gestion des Polylines</h2>

<div class="top-actions">
  <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="handleCSV(event)">
  <button onclick="document.getElementById('csvInput').click()">
    <span class="material-icons">upload_file</span> Upload CSV
  </button>
</div>

<div id="lines-container"></div>

<div class="actions">
  <button onclick="addLine()"><span class="material-icons">add</span> Add line</button>
  <button onclick="downloadGeoJSON()"><span class="material-icons">download</span> Download GeoJSON</button>
  <button onclick="visualizePolylines()"><span class="material-icons">map</span> Visualize</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let map = null;
let polylineLayers = [];

// Tableau de 64 couleurs distinctes
const colors64 = [
"#e6194b","#3cb44b","#ffe119","#4363d8","#f58231","#911eb4","#46f0f0","#f032e6",
"#bcf60c","#fabebe","#008080","#e6beff","#9a6324","#fffac8","#800000","#aaffc3",
"#808000","#ffd8b1","#000075","#808080","#ffffff","#000000","#ff0000","#00ff00",
"#0000ff","#ffff00","#ff00ff","#00ffff","#800000","#808000","#008000","#800080",
"#008080","#000080","#ffa500","#a52a2a","#8a2be2","#5f9ea0","#d2691e","#ff7f50",
"#6495ed","#dc143c","#00008b","#008b8b","#b8860b","#006400","#8b008b","#556b2f",
"#ff8c00","#9932cc","#8b0000","#e9967a","#8fbc8f","#483d8b","#2f4f4f","#00ced1",
"#9400d3","#ff1493","#00bfff","#696969","#1e90ff","#b22222","#228b22","#ff69b4"
];

function decodePolyline(str) {
  let index=0, lat=0, lng=0, coordinates=[];
  while(index<str.length){
    let result=0, shift=0, b;
    do { b=str.charCodeAt(index++)-63; result|=(b&0x1f)<<shift; shift+=5; } while(b>=0x20);
    lat += (result&1)?~(result>>1):(result>>1);
    result=0; shift=0;
    do { b=str.charCodeAt(index++)-63; result|=(b&0x1f)<<shift; shift+=5; } while(b>=0x20);
    lng += (result&1)?~(result>>1):(result>>1);
    coordinates.push([lat/1e5,lng/1e5]);
  }
  return coordinates;
}

function addLine(name="",polyline=""){
  const container=document.getElementById("lines-container");
  const row=document.createElement("div");
  row.className="line-row";
  row.innerHTML=`
    <input class="name" placeholder="name" value="${name}">
    <input class="polyline" placeholder="polyline" value="${polyline}">
    <button class="trash" title="Supprimer"><span class="material-icons">delete</span></button>
  `;
  row.querySelector(".trash").onclick=()=>row.remove();
  container.appendChild(row);
}

function downloadGeoJSON(){
  const rows=document.querySelectorAll(".line-row");
  const features=[];
  rows.forEach(row=>{
    const name=row.querySelector(".name").value.trim();
    const polyline=row.querySelector(".polyline").value.trim();
    if(!name||!polyline) return;
    const coords=decodePolyline(polyline);
    const coordinates=coords.map(c=>[c[1],c[0]]);
    features.push({type:"Feature",properties:{name},geometry:{type:"LineString",coordinates}});
  });
  const geojson={type:"FeatureCollection",features};
  const blob=new Blob([JSON.stringify(geojson,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="lines.geojson";
  a.click();
  URL.revokeObjectURL(url);
}

function handleCSV(event){
  const file=event.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=function(e){
    const text=e.target.result;
    const lines=text.split(/\r?\n/).filter(l=>l.trim()!=="");
    const startIndex=lines[0].toLowerCase().includes("name")?1:0;
    for(let i=startIndex;i<lines.length;i++){
      const [name,polyline]=lines[i].split(",");
      if(name && polyline) addLine(name.trim(),polyline.trim());
    }
  };
  reader.readAsText(file);
}

function colorFromName(name){
  let hash=0;
  for(let i=0;i<name.length;i++) hash += name.charCodeAt(i);
  return colors64[hash % colors64.length];
}

function visualizePolylines(){
  const rows=document.querySelectorAll(".line-row");
  if(rows.length===0) return alert("Aucune polyline à visualiser.");

  if(!map){
    map=L.map("map").setView([0,0],2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'© OpenStreetMap'
    }).addTo(map);
  }

  polylineLayers.forEach(l=>map.removeLayer(l));
  polylineLayers=[];

  const bounds=[];
  rows.forEach(row=>{
    const name=row.querySelector(".name").value.trim();
    const polyline=row.querySelector(".polyline").value.trim();
    if(!name||!polyline) return;
    const coords=decodePolyline(polyline);
    const color=colorFromName(name); // couleur déterministe parmi 64
    const polylineLayer=L.polyline(coords,{color}).addTo(map);
    polylineLayer.bindPopup(name);
    polylineLayers.push(polylineLayer);
    bounds.push(...coords);
  });

  if(bounds.length>0) map.fitBounds(bounds);
}

// 3 lignes par défaut
addLine();
addLine();
addLine();
</script>

</body>
</html>
