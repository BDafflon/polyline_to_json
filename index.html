<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Polyline → GeoJSON</title>
<!-- Material Icons CDN -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 900px;
    margin: 40px auto;
  }

  .line-row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    align-items: center;
  }

  input {
    padding: 6px;
    font-size: 14px;
  }

  .name {
    width: 120px;
  }

  .polyline {
    flex: 1;
  }

  button {
    padding: 6px 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    border: 1px solid #ccc;
    background: transparent;
    color: #333;
    font-size: 14px;
    transition: background 0.2s, color 0.2s;
  }

  button:hover {
    background: #f0f0f0;
    color: #000;
  }

  .material-icons {
    font-size: 20px;
    margin-right: 4px;
  }

  .actions, .top-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 20px;
  }

  .top-actions {
    margin-bottom: 20px;
  }

  .trash {
    border: none;
    padding: 4px;
    background: transparent;
    color: #e53935;
  }

  .trash:hover {
    background: #fce4e4;
  }
</style>
</head>
<body>

<h2>Gestion des Polylines</h2>

<div class="top-actions">
  <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="handleCSV(event)">
  <button onclick="document.getElementById('csvInput').click()">
    <span class="material-icons">upload_file</span> Upload CSV
  </button>
</div>

<div id="lines-container"></div>

<div class="actions">
  <button onclick="addLine()">
    <span class="material-icons">add</span> Add line
  </button>
  <button onclick="downloadGeoJSON()">
    <span class="material-icons">download</span> Download GeoJSON
  </button>
</div>

<script>
function decodePolyline(str) {
  let index = 0, lat = 0, lng = 0;
  const coordinates = [];

  while (index < str.length) {
    let result = 0, shift = 0, b;

    do {
      b = str.charCodeAt(index++) - 63;
      result |= (b & 0x1f) << shift;
      shift += 5;
    } while (b >= 0x20);

    const dlat = (result & 1) ? ~(result >> 1) : (result >> 1);
    lat += dlat;

    result = 0;
    shift = 0;

    do {
      b = str.charCodeAt(index++) - 63;
      result |= (b & 0x1f) << shift;
      shift += 5;
    } while (b >= 0x20);

    const dlng = (result & 1) ? ~(result >> 1) : (result >> 1);
    lng += dlng;

    coordinates.push([lng / 1e5, lat / 1e5]);
  }

  return coordinates;
}

function addLine(name = "", polyline = "") {
  const container = document.getElementById("lines-container");

  const row = document.createElement("div");
  row.className = "line-row";

  row.innerHTML = `
    <input class="name" placeholder="name" value="${name}">
    <input class="polyline" placeholder="polyline" value="${polyline}">
    <button class="trash" title="Supprimer">
      <span class="material-icons">delete</span>
    </button>
  `;

  row.querySelector(".trash").onclick = () => row.remove();

  container.appendChild(row);
}

function downloadGeoJSON() {
  const rows = document.querySelectorAll(".line-row");
  const features = [];

  rows.forEach(row => {
    const name = row.querySelector(".name").value.trim();
    const polyline = row.querySelector(".polyline").value.trim();

    if (!name || !polyline) return;

    const coordinates = decodePolyline(polyline);

    features.push({
      type: "Feature",
      properties: { name },
      geometry: {
        type: "LineString",
        coordinates
      }
    });
  });

  const geojson = {
    type: "FeatureCollection",
    features
  };

  const blob = new Blob(
    [JSON.stringify(geojson, null, 2)],
    { type: "application/json" }
  );

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "lines.geojson";
  a.click();
  URL.revokeObjectURL(url);
}

function handleCSV(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();

  reader.onload = function(e) {
    const text = e.target.result;
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");

    const startIndex = lines[0].toLowerCase().includes("name") ? 1 : 0;

    for (let i = startIndex; i < lines.length; i++) {
      const [name, polyline] = lines[i].split(",");

      if (name && polyline) {
        addLine(name.trim(), polyline.trim());
      }
    }
  };

  reader.readAsText(file);
}

// 3 lignes par défaut
addLine();
addLine();
addLine();
</script>

</body>
</html>
